{# Post template - handles displaying a single post with all its components #}
<div class="post {{ post.status }}{{ " solo" if solo }}" id="post-{{ post.key }}">
    {###################################################################################}
    {# Body #}
    {###################################################################################}
    {% if post.body and post.status != "banned" %}
    <div class="post-body">
        {% filter indent(8) %}
        {# Handle YouTube embeds differently in solo view #}
        {% if solo and post.youtube %}
        {{ post.body|unlink_youtube_thumbnails }}
        {# Show full body in solo view or if no intro limit exists #}
        {% elif solo or post.intro_limit is none %}
        {{ post.body }}
        {# Otherwise truncate body to intro limit #}
        {% else %}
        {% set intro_limit = post.intro_limit %}
        {{ post.body|byte_slice(intro_limit) }}
        {% endif %}
        {% endfilter +%}
    </div>
    {# Show "See more" link for truncated posts #}
    {% if not solo and post.intro_limit %}
    <div class="see-more">
        <a href="/p/{{ post.key }}">[See moreâ€¦]</a>
    </div>
    {% endif %}
    {% endif %}
    {###################################################################################}
    {# Media #}
    {###################################################################################}
    {# Include the media template if we have media file #}
    {% if post.media_filename and post.status not in ["processing", "rejected", "banned"] %}
    {% set media_path = none %}
    {% set use_thumb = not solo and post.thumb_filename %}
    {# For approved or delisted posts, use public media paths #}
    {% if post.status in ["approved", "delisted"] %}
    {% set media_filename = (post.thumb_filename if post.media_category == "image" and use_thumb)
        or (post.compat_video if post.compat_video)
        or post.media_filename %}
    {% set media_path = "/m/" + post.key + "/" + media_filename|urlencode %}
    {# For pending/reported posts, allow admins/mods to see encrypted media #}
    {% elif user.account and (
        (user.account.role in ["admin", "mod"] and post.status == "pending")
        or (user.account.role == "admin" and post.status == "reported")) %}
    {% set media_path = "/decrypt-media/" + post.key %}
    {% endif %}
    {% if media_path %}
    {% filter indent(4) %}
    {%+ include "media.jinja" +%}
    {% endfilter %}
    {% endif %}
    {% endif %}
    {###################################################################################}
    {# Status #}
    {###################################################################################}
    {# Show status indicator for non-approved posts #}
    {% if post.status != "approved" %}
    <div class="status">
        {% if post.media_filename %}
        File: {{ post.media_filename|escape }}<br>
        {% endif %}
        Status: {{ post.status|capitalize }}
    </div>
    {% endif %}
    {###################################################################################}
    {# Info #}
    {###################################################################################}
    {# Show creation timestamp in solo view #}
    {% if solo %}
    {% if post.media_category == "video" and post.compat_video %}
    <div id="original-video">
        {% set original_path = "/m/" + post.key + "/" + post.media_filename|urlencode %}
        Original: <a href="{{ original_path }}">{{ post.media_filename }}</a>
    </div>
    {% endif %}
    <div id="created-at">
        <time datetime="{{ post.created_at_html }}">{{ post.created_at_rfc5322 }}</time>
    </div>
    {% endif %}
    {###################################################################################}
    {# Arrow #}
    {###################################################################################}
    {# Show arrow link to solo view for specific post types #}
    {% if not solo
        and post.status not in ["rejected", "banned"]
        and (post.media_category is none
            or post.media_category != "image"
            or (post.status in ["pending", "reported"]
                and user.account and user.account.role not in ["admin", "mod"])
            or post.status == "processing")
        and not post.youtube
        and post.intro_limit is none %}
    <div class="arrow">
        <a href="/p/{{ post.key }}">&rarr;</a>
    </div>
    {% endif %}
    {###################################################################################}
    {# Review #}
    {###################################################################################}
    {# Show moderation controls for admins and moderators #}
    {% if (user.account.role == "admin" and post.status in ["pending", "delisted", "reported"])
        or (user.account.role == "mod" and post.status in ["pending", "delisted"])
        or ((user.account.role == "admin" or (user.account.role == "mod" and post.recent))
            and post.status == "approved" and solo) %}
    {% filter indent(4) %}
    {%+ include "review.jinja" +%}
    {% endfilter %}
    {% endif %}
    {###################################################################################}
    {# Hide #}
    {###################################################################################}
    {# Allow post author to hide their own rejected posts #}
    {% if post.status == "rejected" and
        (post.session_token and post.session_token == user.session_token
            or (post.account_id and user.account
                and post.account_id == user.account.id)) %}
    <form action="/hide-post" method="post">
        <input type="hidden" name="session_token" value="{{ user.session_token }}">
        <input type="hidden" name="key" value="{{ post.key }}">
        <button type="submit">Hide</button>
    </form>
    {# Allow client-side hiding of dynamically reported/rejected/banned posts #}
    {% elif post.status in ["rejected", "banned"]
        or (post.status == "reported" and user.account.role != "admin") %}
    <button class="hide-post">Hide</button>
    {% endif %}
</div>
