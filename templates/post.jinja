{% set user_account = user.account_opt if user.account_opt is not none %}
{% set role = user_account.role if user.account_opt is not none %}
{% set status = post.status %}
{% set key = post.key %}
{% set media_path_opt = none %}
{% set recent = post.recent_opt %}
<div class="post {{ status }}{{ " solo" if solo }}" id="post-{{ key }}">
    {###################################################################################}
    {# Body #}
    {###################################################################################}
    {% if post.body|length > 0 and status != "banned" %}
    <div class="body">
        {% filter indent(8) %}
        {% if solo and post.youtube %}
        {{ post.body|remove_youtube_thumbnail_links }}
        {% elif solo or post.intro_limit_opt is none %}
        {{ post.body }}
        {% else %}
        {% set intro_limit = post.intro_limit_opt %}
        {{ post.body|byte_slice(intro_limit) }}
        {% endif %}
        {% endfilter +%}
    </div>
    {% if not solo and post.intro_limit_opt is not none %}
    <div class="see-more">
        <a href="/post/{{ key }}">[See moreâ€¦]</a>
    </div>
    {% endif %}
    {% endif %}
    {###################################################################################}
    {# Media #}
    {###################################################################################}
    {% if post.media_filename_opt is not none %}
    {% set media_filename = post.media_filename_opt %}
    {% if status in ["approved", "delisted"] %}
    {% set thumbnail = post.thumbnail_opt if post.thumbnail_opt is not none %}
    {% set optimal_filename =
        thumbnail if not solo and post.thumbnail_opt is not none
        else media_filename %}
    {% set media_path_opt = "/m/" + key + "/" + optimal_filename|urlencode %}
    {% elif user.account_opt is not none and (
        (role in ["admin", "mod"] and status == "pending")
        or (role == "admin" and status == "reported")) %}
    {% set media_path_opt = "/decrypt-media/" + key %}
    {% endif %}
    {% if media_path_opt is not none %}
    {% filter indent(4) %}
    {%+ include "media.jinja" +%}
    {% endfilter %}
    {% endif %}
    {% endif %}
    {###################################################################################}
    {# Status #}
    {###################################################################################}
    {% if status != "approved" %}
    <div class="status">
        {% if post.media_filename_opt is not none %}
        File: {{ media_filename|escape }}<br>
        {% endif %}
        Status: {{ status|capitalize }}
    </div>
    {% endif %}
    {###################################################################################}
    {# Info #}
    {###################################################################################}
    {% if solo %}
    {% set created_at_html = post.created_at_html_opt %}
    {% set created_at_rfc5322 = post.created_at_rfc5322_opt %}
    <div id="created-at">
        <time datetime="{{ created_at_html }}">{{ created_at_rfc5322 }}</time>
    </div>
    {% endif %}
    {###################################################################################}
    {# Arrow #}
    {###################################################################################}
    {% set media_category = post.media_category_opt if post.media_category_opt is not none %}
    {% if not solo
        and status not in ["rejected", "banned"]
        and (post.media_category_opt is not none and media_category != "image"
            or (status in ["pending", "reported"]
                and user.account_opt is not none and role not in ["admin", "mod"]))
        and not post.youtube
        and post.intro_limit_opt is none %}
    <div class="arrow">
        <a href="/post/{{ key }}">&rarr;</a>
    </div>
    {% endif %}
    {###################################################################################}
    {# Review #}
    {###################################################################################}
    {% if user.account_opt is not none and (
        (role == "admin" and status in ["pending", "delisted", "reported"])
        or (role == "mod" and status in ["pending", "delisted"])
        or ((role == "admin" or (role == "mod" and recent)) and status == "approved" and solo)) %}
    {% filter indent(4) %}
    {%+ include "review.jinja" +%}
    {% endfilter %}
    {% endif %}
    {###################################################################################}
    {# Hide #}
    {###################################################################################}
    {% set session_token = post.session_token_opt if post.session_token_opt is not none %}
    {% set post_account_id = post.account_id_opt if post.account_id_opt is not none %}
    {% if status == "rejected" and
        (post.session_token_opt is not none and session_token == user.session_token
            or (post.account_id_opt is not none and user.account_opt is not none
                and post_account_id == user_account.id)) %}
    <form action="/hide-post" method="post">
        <input type="hidden" name="session_token" value="{{ user.session_token }}">
        <input type="hidden" name="key" value="{{ key }}">
        <input type="submit" value="Hide">
    </form>
    {% elif status in ["rejected", "banned"]
        or (status == "reported" and user.account_opt is not none and role == "mod") %}
    <button onclick="removeHiddenPost(this)">Hide</button>
    {% endif %}
</div>
