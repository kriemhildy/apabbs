{# Media display template for images, videos, and audio files #}
{# Set filename, dimensions and type based on whether to use thumbnail or full media #}
{# We should probably move a lot of this into Rust #}
{% set thumb = not solo and post.thumb_filename_opt is not none %}
{# For approved or delisted posts, use public media paths #}
{% if post.status in ["approved", "delisted"] %}
{% set media_filename = (post.thumb_filename_opt if post.media_category_opt == "image" and thumb)
    or (post.compat_video_opt if post.compat_video_opt is not none and not chromium)
    or post.media_filename_opt %}
{% set media_path = "/m/" + post.key + "/" + media_filename|urlencode %}
{# For pending/reported posts, allow admins/mods to see encrypted media #}
{% elif user.account_opt is not none and (
    (user.account_opt.role in ["admin", "mod"] and post.status == "pending")
    or (user.account_opt.role == "admin" and post.status == "reported")) %}
{% set media_path = "/decrypt-media/" + post.key %}
{% endif %}
{% set width = post.thumb_width_opt if thumb else post.media_width_opt %}
{% set height = post.thumb_height_opt if thumb else post.media_height_opt %}
<div class="media">
    {# Image display handling #}
    {% if post.media_category_opt == "image" %}
    {% set solo_path = "/p/" + post.key %}
    {% if solo %}
    <img src="{{ media_path }}" alt="Image {{ media_filename }}" width="{{ width }}" height="{{ height }}">
    {% else %}
    <a href="{{ solo_path }}"><img src="{{ media_path }}" alt="Post {{ post.key }}" width="{{ width }}" height="{{ height }}"></a>
    {% endif %}
    {# Video display handling with poster image #}
    {% elif post.media_category_opt == "video" %}
    {% set mime_type = "video/mp4" if not chromium else post.media_mime_type_opt %}
    {% set poster_attr = "" %}
    {% if post.video_poster_opt is not none %}
    {% set poster_filename = post.thumb_filename_opt if thumb else post.video_poster_opt %}
    {% set poster_path = "/m/" + post.key + "/" + poster_filename|urlencode %}
    {% endif %}
    <video width="{{ width }}" height="{{ height }}" controls poster="{{ poster_path }}" preload="metadata">
        <source src="{{ media_path }}" type="{{ mime_type }}">
        Video {{ post.media_filename_opt }}
    </video>
    {# Audio file display handling #}
    {% elif post.media_category_opt == "audio" %}
    <audio controls>
        <source src="{{ media_path }}" type="{{ mime_type }}">
        Audio {{ post.media_filename_opt }}
    </audio>
    {% endif %}
</div>
